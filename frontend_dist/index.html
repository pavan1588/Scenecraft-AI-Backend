<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SceneCraft AI — Analyzer & Editor</title>
  <style>
    :root{
      /* Locked palette for consistency */
      --bg: #0b0b0c;
      --panel: #121214;
      --muted: #1b1b1f;
      --text: #e7e7ea;
      --subtle: #b7b7c2;
      --brand: #caa656;    /* gold */
      --brand-weak: #9b7d3e;
      --ok: #37c189;       /* green-locked */
      --warn: #e6b84c;     /* amber-locked */
      --bad: #e06464;      /* red-locked */
      --accent: #6aa9ff;   /* blue for links */
      --border: #26262b;

      /* Heatmap gradient stops (don’t change) */
      --hm-low: #2b2f3a;
      --hm-mid: #7a84a6;
      --hm-high: #caa656;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{display:flex;gap:10px;align-items:flex-end}
    .brand h1{margin:0;font-size:20px;letter-spacing:.3px}
    .brand em{font-style:normal;color:var(--brand);font-weight:600}
    .tm{font-size:11px;position:relative;top:-6px;margin-left:2px;color:var(--brand)}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:12px;background:var(--panel);cursor:pointer;color:var(--subtle)}
    .tab.active{color:var(--text);border-color:var(--brand);box-shadow:0 0 0 1px #000 inset, 0 0 0 1px var(--brand)}
    .card{background:linear-gradient(180deg,var(--panel),var(--muted));border:1px solid var(--border);border-radius:16px;padding:16px;margin:14px 0;box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .row{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){.row{grid-template-columns:1.2fr .8fr}}
    textarea{width:100%;min-height:220px;background:#0f0f12;border:1px solid var(--border);border-radius:14px;color:var(--text);padding:12px;resize:vertical}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    button{background:var(--brand);color:#121212;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.secondary{background:#1b1b1f;color:var(--text);border:1px solid var(--border)}
    .muted{color:var(--subtle)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .divider{height:1px;background:var(--border);margin:10px 0 6px}
    .tag{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--subtle);margin-right:6px}
    .legend{display:flex;gap:10px;flex-wrap:wrap}
    .legend .dot{width:10px;height:10px;border-radius:50%}
    .legend span{display:flex;align-items:center;gap:6px}
    .grid{display:grid;gap:10px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    /* Heat map cells */
    .heat-row{display:grid;grid-template-columns:repeat(20,1fr);gap:2px}
    .cell{height:16px;border-radius:4px;background:var(--hm-low)}
    .kpi{display:flex;justify-content:space-between;gap:10px}
    .kpi .pill{padding:8px 10px;border-radius:10px;background:#111;border:1px solid var(--border)}
    .pill.good{border-color:var(--ok);color:var(--ok)}
    .pill.mid{border-color:var(--warn);color:var(--warn)}
    .pill.bad{border-color:var(--bad);color:var(--bad)}
    /* Sticky nav on scroll */
    .sticky{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,var(--bg),rgba(11,11,12,0.75));backdrop-filter:saturate(120%) blur(6px);padding:10px 0 14px;margin:0 -2px}
    /* Output blocks */
    .output{white-space:pre-wrap}
    /* Hide sections initially (preserves your behavior) */
    #analyzerSection, #editorSection{display:none}
    /* Copy/selection protections (will respect your previous handlers if any) */
    body.noselect *::selection{background:transparent}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>SceneCraft <em>AI</em><span class="tm">TM</span></h1>
      </div>
      <nav class="sticky" id="tabs">
        <button class="tab active" data-target="homeSection">Home</button>
        <button class="tab" data-target="analyzerSection">Scene Analyzer</button>
        <button class="tab" data-target="editorSection">Scene Editor</button>
        <span class="tag">Full Script Writer (coming)</span>
        <span class="tag">Pricing</span>
      </nav>
    </header>

    <!-- Home -->
    <section id="homeSection" class="card">
      <h2 style="margin-top:0">Welcome</h2>
      <p class="muted">Paste a scene in Analyzer for cinematic diagnostics; use Editor for line‑by‑line rewrite suggestions. Hindi/Kannada supported (native or transliteration). Visuals are stable across runs.</p>
      <div class="legend" style="margin-top:8px">
        <span><span class="dot" style="background:var(--ok)"></span>Strong</span>
        <span><span class="dot" style="background:var(--warn)"></span>Needs Attention</span>
        <span><span class="dot" style="background:var(--bad)"></span>Weak</span>
      </div>
    </section>

    <!-- Analyzer -->
    <section id="analyzerSection" class="card">
      <div class="row">
        <div>
          <h3 style="margin:0 0 8px">Scene Analyzer</h3>
          <textarea id="analyzeInput" placeholder="Paste your scene (2 pages max is ideal)…"></textarea>
          <div class="controls">
            <button id="analyzeBtn">Analyze</button>
            <button class="secondary" id="clearAnalyze">Clear</button>
            <span id="analyzeStatus" class="muted"></span>
          </div>
        </div>
        <div>
          <div class="kpi">
            <div class="pill" id="kpiStructure">Structure: —</div>
            <div class="pill" id="kpiRealism">Realism: —</div>
            <div class="pill" id="kpiResonance">Resonance: —</div>
          </div>
          <div class="divider"></div>
          <div class="grid cols-2">
            <div>
              <h4 style="margin:6px 0">Beat Heat Map</h4>
              <div id="heatMap" class="heat-row" aria-label="Beat Heat Map"></div>
            </div>
            <div>
              <h4 style="margin:6px 0">Analytics Summary</h4>
              <div id="analyticsSummary" class="output mono muted">Run analysis to populate…</div>
            </div>
          </div>
          <div class="divider"></div>
          <h4 style="margin:6px 0">Detailed Analysis</h4>
          <div id="analysisOut" class="output">—</div>
        </div>
      </div>
    </section>

    <!-- Editor -->
    <section id="editorSection" class="card">
      <div class="row">
        <div>
          <h3 style="margin:0 0 8px">Scene Editor</h3>
          <textarea id="editInput" placeholder="Paste your scene + context (treated as one unified text)…"></textarea>
          <div class="controls">
            <button id="editBtn">Get Line-by-Line Suggestions</button>
            <button class="secondary" id="clearEdit">Clear</button>
            <span id="editStatus" class="muted"></span>
          </div>
        </div>
        <div>
          <h4 style="margin:0 0 8px">Rewrite Suggestions</h4>
          <div id="editOut" class="output mono">—</div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // Basic tab toggle (keeps your section IDs)
    const tabs = document.querySelectorAll('.tab');
    const sections = {
      homeSection: document.getElementById('homeSection'),
      analyzerSection: document.getElementById('analyzerSection'),
      editorSection: document.getElementById('editorSection'),
    };
    function showSection(id){
      Object.values(sections).forEach(s => s.style.display = 'none');
      tabs.forEach(t => t.classList.remove('active'));
      document.getElementById(id).style.display = 'block';
      document.querySelector(`.tab[data-target="${id}"]`)?.classList.add('active');
    }
    tabs.forEach(btn=>{
      btn.addEventListener('click',()=>showSection(btn.dataset.target));
    });
    // Default landing on Home
    showSection('homeSection');

    // Locked color ramp for heat map
    function heatColor(value){ // value in [0,1]
      // 3-stop gradient: low -> mid -> high (fixed hex)
      const stops = [
        {pos:0.0, r:0x2b, g:0x2f, b:0x3a}, // --hm-low
        {pos:0.55,r:0x7a, g:0x84, b:0xa6}, // --hm-mid
        {pos:1.0, r:0xca, g:0xa6, b:0x56}  // --hm-high
      ];
      let a=stops[0], b=stops[2];
      if(value<=stops[1].pos){ b=stops[1]; }
      else { a=stops[1]; }
      const t=(value - a.pos)/(b.pos - a.pos);
      const r=Math.round(a.r + (b.r-a.r)*t);
      const g=Math.round(a.g + (b.g-a.g)*t);
      const bl=Math.round(a.b + (b.b-a.b)*t);
      return `rgb(${r},${g},${bl})`;
    }

    // KPI pill mapping (stable)
    function kpiClass(score){ // expects 0..100 or null
      if(score==null || isNaN(score)) return '';
      if(score>=70) return 'pill good';
      if(score>=45) return 'pill mid';
      return 'pill bad';
    }

    // ANALYZER
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analyzeInput = document.getElementById('analyzeInput');
    const analyzeStatus = document.getElementById('analyzeStatus');
    const analysisOut = document.getElementById('analysisOut');
    const analyticsSummary = document.getElementById('analyticsSummary');
    const heatMap = document.getElementById('heatMap');
    const kpiStructure = document.getElementById('kpiStructure');
    const kpiRealism = document.getElementById('kpiRealism');
    const kpiResonance = document.getElementById('kpiResonance');

    function renderHeatMap(beats){
      heatMap.innerHTML='';
      const total = 20; // lock to 20 cells for stability
      for(let i=0;i<total;i++){
        const v = beats && beats[i]!=null ? beats[i] : 0;
        const cell=document.createElement('div');
        cell.className='cell';
        const t = Math.max(0, Math.min(1, v)); // clamp
        cell.style.background = heatColor(t);
        cell.title = `Beat ${i+1}: ${(t*100).toFixed(0)}% intensity`;
        heatMap.appendChild(cell);
      }
    }

    function renderKPIs(k){
      const s = (k && typeof k.structure==='number') ? Math.round(k.structure) : null;
      const r = (k && typeof k.realism==='number') ? Math.round(k.realism) : null;
      const a = (k && typeof k.resonance==='number') ? Math.round(k.resonance) : null;
      kpiStructure.className = 'pill ' + (kpiClass(s).split(' ')[1]||'');
      kpiRealism.className   = 'pill ' + (kpiClass(r).split(' ')[1]||'');
      kpiResonance.className = 'pill ' + (kpiClass(a).split(' ')[1]||'');
      kpiStructure.textContent = `Structure: ${s??'—'}`;
      kpiRealism.textContent   = `Realism: ${r??'—'}`;
      kpiResonance.textContent = `Resonance: ${a??'—'}`;
    }

    analyzeBtn.addEventListener('click', async ()=>{
      const scene = (analyzeInput.value||'').trim();
      if(!scene){ analysisOut.textContent='Please paste a scene.'; return; }
      analyzeStatus.textContent='Analyzing…';
      analysisOut.textContent='—';
      analyticsSummary.textContent='Computing analytics…';
      renderHeatMap(null);
      renderKPIs(null);
      try{
        const res = await fetch('/analyze',{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'x-user-agreement':'true'
          },
          body: JSON.stringify({ scene })
        });
        if(!res.ok){ throw new Error('Server error'); }
        const data = await res.json();
        // Expected payload keys (unchanged): data.analysis, data.analytics_summary, data.beat_intensity (0..1 array length<=20), data.kpis {structure,realism,resonance}
        analysisOut.textContent = data.analysis || '—';
        analyticsSummary.textContent = data.analytics_summary || '—';
        renderHeatMap(Array.isArray(data.beat_intensity)?data.beat_intensity.slice(0,20):null);
        renderKPIs(data.kpis || null);
        analyzeStatus.textContent='Done.';
      }catch(err){
        analysisOut.textContent='Internal Server Error. Please try again.';
        analyticsSummary.textContent='—';
        analyzeStatus.textContent='';
        renderHeatMap(null);
        renderKPIs(null);
      }
    });
    document.getElementById('clearAnalyze').addEventListener('click',()=>{
      analyzeInput.value=''; analysisOut.textContent='—'; analyticsSummary.textContent='Run analysis to populate…';
      renderHeatMap(null); renderKPIs(null); analyzeStatus.textContent='';
    });

    // EDITOR
    const editBtn = document.getElementById('editBtn');
    const editInput = document.getElementById('editInput');
    const editStatus = document.getElementById('editStatus');
    const editOut = document.getElementById('editOut');
    editBtn.addEventListener('click', async ()=>{
      const scene = (editInput.value||'').trim();
      if(!scene){ editOut.textContent='Please paste a scene.'; return; }
      editStatus.textContent='Generating suggestions…';
      editOut.textContent='—';
      try{
        const res = await fetch('/edit',{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'x-user-agreement':'true'
          },
          body: JSON.stringify({ scene }) // unified scene+context (as requested)
        });
        if(!res.ok){ throw new Error('Server error'); }
        const data = await res.json();
        editOut.textContent = data.suggestions || data.analysis || '—';
        editStatus.textContent='Done.';
      }catch(err){
        editOut.textContent='Internal Server Error. Please try again.';
        editStatus.textContent='';
      }
    });
    document.getElementById('clearEdit').addEventListener('click',()=>{
      editInput.value=''; editOut.textContent='—'; editStatus.textContent='';
    });

    // Optional: disable selection if you were already doing it; leaving hook only.
    // document.body.classList.add('noselect');
    // document.addEventListener('contextmenu', e=>e.preventDefault());
  </script>
</body>
</html>
