<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SceneCraft AI</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #0e0e0e;
    color: gold;
    margin: 0;
    padding: 2rem;
  }
  .container {
    max-width: 900px;
    margin: auto;
  }
  nav button {
    margin-right: 1rem;
    background: #1f1f1f;
    color: gold;
    border: 1px solid #555;
    padding: 0.6rem 1rem;
    cursor: pointer;
  }
  textarea {
    width: 100%;
    height: 200px;
    margin-bottom: 1rem;
    padding: 1rem;
    font-size: 1rem;
    background: #222;
    color: #fff;
    border: 1px solid #444;
  }
  .pill {
    background: var(--accent, #5aa9ff);
    color: #000;
    padding: 2px 8px;
    border-radius: 20px;
  }
  details summary {
    cursor: pointer;
    font-weight: bold;
  }
  .retry-btn {
    background: #ff4444;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    margin-top: 10px;
    cursor: pointer;
    border-radius: 4px;
    display: none;
  }
</style>
</head>
<body>
<div class="container">
  <nav>
    <button onclick="showSection('analyzer')">Scene Analyzer</button>
    <button onclick="showSection('editor')">Scene Editor</button>
  </nav>

  <!-- Scene Analyzer Section -->
  <section id="analyzer">
    <h2>Scene Analyzer</h2>
    <textarea id="scene-analyze" placeholder="Paste your scene here..."></textarea>
    <div id="anWC">0 words</div>
    <button id="analyzeBtn" onclick="analyze()">Analyze</button>
    <button id="retryAnalyze" class="retry-btn" onclick="retryAnalyzeFn()">Retry</button>
    <div id="summaryText"></div>
    <div id="beats"></div>
    <div id="suggestions"></div>
    <svg height="120" width="120">
      <circle id="moodArc" cx="60" cy="60" r="52" stroke="gold" stroke-width="4" fill="none" stroke-dasharray="326.7"></circle>
    </svg>
    <span id="moodVal"></span>
  </section>

  <!-- Scene Editor Section -->
  <section id="editor" style="display:none;">
    <h2>Scene Editor</h2>
    <textarea id="scene-edit" placeholder="Paste your scene here..."></textarea>
    <div id="edWC">0 words</div>
    <button id="editBtn" onclick="editScene()">Edit</button>
    <button id="retryEdit" class="retry-btn" onclick="retryEditFn()">Retry</button>
    <div id="editOutput"></div>
  </section>

  <audio id="ambience" loop></audio>
  <button id="audioBtn" disabled onclick="toggleAudio()">Play ambience</button>
</div>

<script>
const el = id => document.getElementById(id);
const wc = t => t.trim() ? t.trim().split(/\s+/).length : 0;
const analyzeCache = new Map();
const inFlight = new Set();
let lastAnalyzeScene = '';
let lastEditScene = '';

// Word counters
el('scene-analyze').addEventListener('input', ()=> el('anWC').textContent = wc(el('scene-analyze').value)+' words');
el('scene-edit').addEventListener('input', ()=> el('edWC').textContent = wc(el('scene-edit').value)+' words');

// Mood gauge helper
function setGauge(val){
  const circ = 2*Math.PI*52;
  const off = circ * (1 - (val/100));
  el('moodArc').setAttribute('stroke-dashoffset', String(off));
  el('moodVal').textContent = Math.round(val);
}

// Immersive reader
async function typeSummary(text){
  const dest = el('summaryText');
  dest.textContent = '';
  for(const ch of text){
    dest.textContent += ch;
    await new Promise(r=>setTimeout(r, 8));
  }
}

function clearAnalysisUI(){
  el('summaryText').textContent = '';
  el('beats').innerHTML = '';
  el('suggestions').innerHTML = '';
  setGauge(0);
  el('audioBtn').disabled = true;
  el('ambience').pause();
  el('retryAnalyze').style.display = 'none';
}

window.toggleAudio = function(){
  const a = el('ambience');
  if(!a.src) return;
  if(a.paused){ a.play(); el('audioBtn').textContent = 'Pause ambience'; }
  else { a.pause(); el('audioBtn').textContent = 'Play ambience'; }
};

function renderAnalysis(obj){
  const col = (obj?.theme?.color)||'#b3d9ff';
  document.documentElement.style.setProperty('--accent', '#5aa9ff');
  document.documentElement.style.setProperty('--accent-soft', col);
  typeSummary(obj.summary || 'Analysis');

  el('beats').innerHTML = '';
  (obj.beats||[]).forEach(b=>{
    const d = document.createElement('div');
    d.innerHTML = `<div class="small"><span class="pill">${b.title||'Beat'}</span> ${(b.insight||'')}</div>`;
    el('beats').appendChild(d);
  });

  el('suggestions').innerHTML = '';
  (obj.suggestions||[]).forEach(s=>{
    const dt = document.createElement('details');
    const sum = document.createElement('summary');
    sum.textContent = s.title || 'Suggestion';
    const body = document.createElement('div');
    body.innerHTML = `<div class="small"><strong>Rationale:</strong> ${s.rationale||''}</div>` +
                     (s.rewrite_example ? `<div class="small"><strong>Rewrite:</strong> ${s.rewrite_example}</div>` : '') +
                     `<div class="small muted"><strong>Director’s Note:</strong> ${s.director_note||''}</div>`;
    dt.appendChild(sum); dt.appendChild(body);
    el('suggestions').appendChild(dt);
  });

  setGauge(Number(obj.analytics?.mood||0));
}

async function sha(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

window.analyze = async function(){
  const scene = el('scene-analyze').value.trim();
  lastAnalyzeScene = scene;
  const btn = el('analyzeBtn');
  const words = wc(scene);
  if(words < 250){ clearAnalysisUI(); el('summaryText').textContent = `Scene too short: ${words}/250 words.`; return; }
  const key = 'an:'+await sha(scene);

  inFlight.add(key);
  btn.disabled = true;
  clearAnalysisUI();
  el('summaryText').textContent = 'Analyzing…';

  try{
    const r = await fetch('/analyze', {
      method:'POST',
      headers:{'Content-Type':'application/json','x-user-agreement':'true'},
      body: JSON.stringify({scene})
    });
    const d = await r.json().catch(()=> ({}));
    if (!r.ok){
      el('summaryText').textContent = `Error: ${d.detail||r.statusText}`;
      el('retryAnalyze').style.display = 'inline-block';
      return;
    }
    const obj = d.analysis || {};
    analyzeCache.set(key, obj);
    renderAnalysis(obj);
  }catch(e){
    el('summaryText').textContent = `Network issue — please retry.`;
    el('retryAnalyze').style.display = 'inline-block';
  }finally{
    inFlight.delete(key);
    btn.disabled = false;
  }
};

window.retryAnalyzeFn = function(){
  if(lastAnalyzeScene) analyze();
};

window.editScene = async function(){
  const scene = el('scene-edit').value.trim();
  lastEditScene = scene;
  const btn = el('editBtn');
  if(wc(scene) < 50){ el('editOutput').textContent = `Scene too short.`; return; }
  btn.disabled = true;
  el('editOutput').textContent = 'Editing…';
  try{
    const r = await fetch('/edit', {
      method:'POST',
      headers:{'Content-Type':'application/json','x-user-agreement':'true'},
      body: JSON.stringify({scene})
    });
    const d = await r.json().catch(()=> ({}));
    if (!r.ok){
      el('editOutput').textContent = `Error: ${d.detail||r.statusText}`;
      el('retryEdit').style.display = 'inline-block';
      return;
    }
    el('editOutput').textContent = d.suggestions ? JSON.stringify(d.suggestions, null, 2) : 'No suggestions found.';
  }catch(e){
    el('editOutput').textContent = `Network issue — please retry.`;
    el('retryEdit').style.display = 'inline-block';
  }finally{
    btn.disabled = false;
  }
};

window.retryEditFn = function(){
  if(lastEditScene) editScene();
};

function showSection(sec){
  el('analyzer').style.display = sec==='analyzer' ? '' : 'none';
  el('editor').style.display = sec==='editor' ? '' : 'none';
}
</script>
</body>
</html>
